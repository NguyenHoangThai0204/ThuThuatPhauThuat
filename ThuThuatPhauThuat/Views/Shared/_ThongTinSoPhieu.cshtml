﻿@{
var tabIndex = ViewBag.TabIndex ?? 0;
}

<div class="row m-0">
    <div class="col-3">
        <!-- Số phiếu -->
        <div class="mb-2">
            <label class="form-label fw-bold">Số phiếu:</label>
            <input type="text" class="form-control thuThuat__soPhieu-tom-select-@tabIndex" value="25761707">
        </div>
        <!-- Nguồn bệnh -->
        <div class="mb-2">
            <label class="form-label fw-bold">Nguồn bệnh:</label>
            <input type="text" class="form-control thuThuat__nguonBenh-tom-select-@tabIndex" name="nguonBenh" value="Trong Bệnh viện" />
        </div>
    </div>
    <div class="col-2">
        <!-- Nhóm máu -->
        <div class="mb-2">
            <label class="form-label fw-bold">Nhóm máu:</label>
            <input type="text" class="form-control thuThuat__nhomMau-tom-select-@tabIndex" name="nhomMau" value="B" />
        </div>
        <!-- Yếu tố Rh -->
        <div class="mb-2">
            <label class="form-label fw-bold">Yếu tố Rh:</label>
            <input type="text" class="form-control thuThuat__yeuToRh-tom-select-@tabIndex" name="yeuToRh" value="Dương tính" />
        </div>
    </div>
    <div class="col-4">
        <!-- Bắt đầu thủ thuật -->
        <div class="mb-2">
            <label class="form-label fw-bold">Bắt đầu thủ thuật:</label>
            <div class="input-icon">
                <input type="text" class="form-control txtDateTimeBatDauThuThuat-@tabIndex"
                       value="@DateTime.Now.ToString("dd-MM-yyyy HH:mm:ss")" autocomplete="off">
                <span class="input-icon-addon">
                    <i class="ti ti-calendar-event"></i>
                </span>
            </div>
        </div>
        <!-- Kết thúc thủ thuật -->
        <div class="mb-2">
            <label class="form-label fw-bold">Kết thúc thủ thuật:</label>
            <div class="input-icon">
                <input type="text" class="form-control txtDateTimeKetThucThuThuat-@tabIndex"
                       value="@DateTime.Now.ToString("dd-MM-yyyy HH:mm:ss")" autocomplete="off">
                <span class="input-icon-addon">
                    <i class="ti ti-calendar-event"></i>
                </span>
            </div>
        </div>
    </div>
    <div class="col-3">
        <!-- Thời gian khóa -->
        <div class="mb-2">
            <label class="form-label fw-bold">Thời gian khóa:</label>
            <input type="text" class="form-control" readonly>
        </div>
        <!-- Người khóa -->
        <div class="mb-2">
            <label class="form-label fw-bold">Người khóa:</label>
            <input type="text" class="form-control" readonly>
        </div>
    </div>
</div>

<script>
    // Dữ liệu mẫu cho các dropdown
    var soPhieuData = [
        { ma: "25761707", ten: "25761707" },
        { ma: "25761708", ten: "25761708" },
        { ma: "25761709", ten: "25761709" }
    ];

    var nguonBenhData = [
        { ma: "TB", ten: "Trong Bệnh viện", vietTat: "tbv" },
        { ma: "NB", ten: "Ngoài Bệnh viện", vietTat: "nbv" },
        { ma: "CK", ten: "Chuyển khoa", vietTat: "ck" },
        { ma: "TC", ten: "Tự chuyển", vietTat: "tc" }
    ];

    var nhomMauData = [
        { ma: "A", ten: "A", vietTat: "a" },
        { ma: "B", ten: "B", vietTat: "b" },
        { ma: "AB", ten: "AB", vietTat: "ab" },
        { ma: "O", ten: "O", vietTat: "o" }
    ];

    var yeuToRhData = [
        { ma: "D", ten: "Dương tính", vietTat: "d+" },
        { ma: "A", ten: "Âm tính", vietTat: "d-" }
    ];

    // Hàm cấu hình Tom Select cho đúng tabIndex
    function configTomSelect(tabIndex) {
        var tomSelectConfigs = [
            {
                className: ".thuThuat__soPhieu-tom-select-" + tabIndex,
                placeholder: "-- Chọn số phiếu --",
                data: soPhieuData
            },
            {
                className: ".thuThuat__nguonBenh-tom-select-" + tabIndex,
                placeholder: "-- Chọn nguồn bệnh --",
                data: nguonBenhData,
                showVietTat: true
            },
            {
                className: ".thuThuat__nhomMau-tom-select-" + tabIndex,
                placeholder: "-- Chọn nhóm máu --",
                data: nhomMauData,
                showVietTat: true,
                disabled: true
            },
            {
                className: ".thuThuat__yeuToRh-tom-select-" + tabIndex,
                placeholder: "-- Chọn yếu tố Rh --",
                data: yeuToRhData,
                showVietTat: true,
                disabled: true
            }
        ];

        tomSelectConfigs.forEach(cfg => {
            let tomSelectConfig = {
                options: cfg.data,
                valueField: "ma",
                labelField: "ten",
                searchField: ["ma", "ten", "vietTat"],
                placeholder: cfg.placeholder,
                maxItems: 1,
                create: cfg.allowCreate || false,
                disabled: cfg.disabled || false
            };

            if (cfg.showVietTat) {
                tomSelectConfig.render = {
                    option: function(data, escape) {
                        return '<div style="display: flex; justify-content: space-between;">' +
                            '<span>' + escape(data.ten) + '</span>' +
                            '<span style="color: #6c757d;">' + escape(data.vietTat || '') + '</span>' +
                            '</div>';
                    },
                    item: function(data, escape) {
                        return '<div>' + escape(data.ten) + '</div>';
                    }
                };
            }

            new TomSelect(cfg.className, tomSelectConfig);
        });
    }

    function configDateTimePicker(tabIndex) {
        $('.txtDateTimeBatDauThuThuat-' + tabIndex + ', .txtDateTimeKetThucThuThuat-' + tabIndex).attachDateTimeGroups();
    }

    function khoiTaoThongTinSoPhieu(tabIndex) {
        configTomSelect(tabIndex);
        configDateTimePicker(tabIndex);
    }
    khoiTaoThongTinSoPhieu(@tabIndex);
</script>